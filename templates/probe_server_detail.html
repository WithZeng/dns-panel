{% extends 'base.html' %}

{% block content %}
<div class="flex items-center justify-between mb-5">
  <div>
    <h1 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">{{ server.name }}</h1>
    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">{{ server.server_type }} · 最后心跳 {{ server.last_seen or '-' }}</p>
  </div>
  <div class="flex items-center gap-2">
    <button id="openEditModal" class="inline-flex items-center rounded-lg bg-slate-900 dark:bg-blue-600 text-white px-3 py-2 text-sm">编辑</button>
    <button id="resetTokenBtn" class="inline-flex items-center rounded-lg border border-rose-200 dark:border-rose-700 text-rose-600 dark:text-rose-400 px-3 py-2 text-sm">重置 Token</button>
    <a href="{{ url_for('probe.probe_servers_page') }}"
      class="inline-flex items-center rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm">返回列表</a>
  </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-5">
  <div class="xl:col-span-2 space-y-5">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
        <div class="text-xs text-slate-500 dark:text-slate-400">CPU 使用率</div>
        <div id="cpuPercent" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">0%</div>
      </div>
      <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
        <div class="text-xs text-slate-500 dark:text-slate-400">内存使用率</div>
        <div id="memPercent" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">0%</div>
      </div>
      <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
        <div class="text-xs text-slate-500 dark:text-slate-400">磁盘使用率</div>
        <div id="diskPercent" class="text-2xl font-bold text-slate-900 dark:text-white mt-1">0%</div>
      </div>
    </div>

    <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-5 shadow-sm">
      <h2 class="text-lg font-bold text-slate-900 dark:text-white mb-3">网络流量（实时）</h2>
      <div style="height: 280px;"><canvas id="netChart"></canvas></div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4">
        <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
          <div class="text-xs text-slate-500 dark:text-slate-400">总上行</div>
          <div id="totalUpVal" class="text-lg font-bold text-slate-900 dark:text-white mt-1">0 GB</div>
        </div>
        <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
          <div class="text-xs text-slate-500 dark:text-slate-400">总下行</div>
          <div id="totalDownVal" class="text-lg font-bold text-slate-900 dark:text-white mt-1">0 GB</div>
        </div>
        <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
          <div class="text-xs text-slate-500 dark:text-slate-400">合计流量</div>
          <div id="totalTrafficVal" class="text-lg font-bold text-slate-900 dark:text-white mt-1">0 GB</div>
        </div>
        <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 shadow-sm">
          <div class="text-xs text-slate-500 dark:text-slate-400">当前速率</div>
          <div id="currentRateVal" class="text-lg font-bold text-slate-900 dark:text-white mt-1">↑0 ↓0 KB/s</div>
        </div>
      </div>
    </div>

    {% if server.server_type == 'aliyun' and ecs_instance %}
    <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-5 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-bold text-slate-900 dark:text-white">流量数据源</h2>
        <div class="inline-flex rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden">
          <button id="tabSdk" class="px-3 py-1.5 text-sm bg-slate-900 text-white">阿里云 SDK 流量</button>
          <button id="tabProbe" class="px-3 py-1.5 text-sm bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200">探针实时流量</button>
        </div>
      </div>
      <div id="sdkPanel">
        <div class="text-sm text-slate-600 dark:text-slate-300">当前阿里云月流量：{{ '%.2f'|format(ecs_instance.current_month_traffic or 0) }} GB</div>
      </div>
      <div id="probePanel" class="hidden">
        <div id="probeTrafficTotal" class="text-sm text-slate-600 dark:text-slate-300">探针累计流量：0 GB</div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        {% if ecs_instance.status == 'Stopped' %}
        <form method="POST" action="{{ url_for('main.start_instance', id=ecs_instance.id) }}" class="inline">
          <button type="submit" class="inline-flex items-center rounded-lg bg-emerald-600 px-3 py-1.5 text-sm text-white">▶ 开机</button>
        </form>
        {% elif ecs_instance.status == 'Running' %}
        <form method="POST" action="{{ url_for('main.stop_instance', id=ecs_instance.id) }}" class="inline">
          <button type="submit" class="inline-flex items-center rounded-lg bg-slate-900 dark:bg-slate-600 px-3 py-1.5 text-sm text-white">⏸ 关机</button>
        </form>
        {% endif %}
        <a href="{{ url_for('main.security_group', id=ecs_instance.id) }}" class="inline-flex items-center rounded-lg border border-slate-200 dark:border-slate-600 px-3 py-1.5 text-sm">安全组</a>
        <a href="{{ url_for('main.instance_detail', id=ecs_instance.id) }}" class="inline-flex items-center rounded-lg border border-slate-200 dark:border-slate-600 px-3 py-1.5 text-sm">ECS 详情</a>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="space-y-5">
    <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-5 shadow-sm">
      <h3 class="text-base font-bold text-slate-900 dark:text-white mb-3">静态信息</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">CPU</span><span class="text-slate-900 dark:text-white">{{ server.cpu_name or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">核心数</span><span class="text-slate-900 dark:text-white">{{ server.cpu_cores or 0 }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">架构</span><span class="text-slate-900 dark:text-white">{{ server.arch or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">OS</span><span class="text-slate-900 dark:text-white">{{ server.os_info or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">虚拟化</span><span class="text-slate-900 dark:text-white">{{ server.virtualization or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">IPv4</span><span class="text-slate-900 dark:text-white">{{ server.ipv4 or '-' }}</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">IPv6</span><span class="text-slate-900 dark:text-white">{{ server.ipv6 or '-' }}</span></div>
        {% if not server.ipv4 %}
        <div class="mt-2 rounded-lg border border-amber-200 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/20 p-2 text-[11px] text-amber-700 dark:text-amber-300">
          IPv4 暂未识别。可按顺序检查：
          1) 探针机是否有公网 IPv4；
          2) 重启探针服务后等待 10-20 秒；
          3) 若经反代接入，请透传 <code>X-Forwarded-For</code> 或 <code>CF-Connecting-IP</code>。
        </div>
        {% endif %}
      </div>
    </div>

    <div class="rounded-2xl bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-5 shadow-sm">
      <h3 class="text-base font-bold text-slate-900 dark:text-white mb-3">系统指标</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Load</span><span id="loadVal" class="text-slate-900 dark:text-white">-</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">TCP/UDP</span><span id="connVal" class="text-slate-900 dark:text-white">-</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">进程数</span><span id="procVal" class="text-slate-900 dark:text-white">-</span></div>
        <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Uptime</span><span id="uptimeVal" class="text-slate-900 dark:text-white">-</span></div>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/30 p-4">
  <div class="w-full max-w-xl rounded-2xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 p-6 shadow-xl">
    <h3 class="text-xl font-bold text-slate-900 dark:text-white">编辑探针服务器</h3>
    <form id="editProbeForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-500 dark:text-slate-400">名称</label>
        <input name="name" required class="w-full mt-1 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm" />
      </div>
      <div>
        <label class="text-xs text-slate-500 dark:text-slate-400">标签</label>
        <input name="tag" class="w-full mt-1 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm" />
      </div>
      <div>
        <label class="text-xs text-slate-500 dark:text-slate-400">备注</label>
        <input name="notes" class="w-full mt-1 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm" />
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-500 dark:text-slate-400">关联 ECS（可选）</label>
        <select name="ecs_instance_id" class="w-full mt-1 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm">
          <option value="">不关联</option>
          {% for e in ecs_instances %}
          <option value="{{ e.id }}">{{ e.name }} ({{ e.instance_id }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="sm:col-span-2 flex justify-end gap-2 mt-2">
        <button type="button" id="closeEditModal" class="rounded-lg border border-slate-200 dark:border-slate-600 px-4 py-2 text-sm">取消</button>
        <button type="submit" class="rounded-lg bg-slate-900 dark:bg-blue-600 text-white px-4 py-2 text-sm">保存</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
  const labels = [];
  const upData = [];
  const downData = [];

  const chart = new Chart(document.getElementById('netChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: '上行 KB/s', data: upData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,.15)', tension: 0.25 },
        { label: '下行 KB/s', data: downData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,.15)', tension: 0.25 },
      ]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });

  function formatUptime(sec) {
    sec = Math.max(0, Number(sec || 0));
    const d = Math.floor(sec / 86400);
    const h = Math.floor((sec % 86400) / 3600);
    const m = Math.floor((sec % 3600) / 60);
    return `${d}d ${h}h ${m}m`;
  }

  async function refreshDetail() {
    const res = await fetch('/api/probe/server/{{ server.id }}');
    const data = await res.json();
    const s = data.server;
    const report = (s.metrics && s.metrics.report) || {};

    document.getElementById('cpuPercent').textContent = `${(s.metrics.cpu_percent || 0).toFixed(1)}%`;
    document.getElementById('memPercent').textContent = `${(s.metrics.mem_percent || 0).toFixed(1)}%`;
    document.getElementById('diskPercent').textContent = `${(s.metrics.disk_percent || 0).toFixed(1)}%`;

    const up = ((report.network && report.network.up) || 0) / 1024;
    const down = ((report.network && report.network.down) || 0) / 1024;

    labels.push(new Date().toLocaleTimeString());
    upData.push(Number(up.toFixed(2)));
    downData.push(Number(down.toFixed(2)));
    if (labels.length > 20) {
      labels.shift(); upData.shift(); downData.shift();
    }
    chart.update();

    const load = report.load || {};
    document.getElementById('loadVal').textContent = `${load.load1 || 0} / ${load.load5 || 0} / ${load.load15 || 0}`;
    const conn = report.connections || {};
    document.getElementById('connVal').textContent = `TCP ${conn.tcp || 0} / UDP ${conn.udp || 0}`;
    document.getElementById('procVal').textContent = report.process_count || 0;
    document.getElementById('uptimeVal').textContent = formatUptime(report.uptime || 0);

    const net = report.network || {};
    const tUp = (Number(net.totalUp || 0) / (1024 ** 3)).toFixed(2);
    const tDown = (Number(net.totalDown || 0) / (1024 ** 3)).toFixed(2);
    const tTotal = (Number(tUp) + Number(tDown)).toFixed(2);
    document.getElementById('totalUpVal').textContent = tUp + ' GB';
    document.getElementById('totalDownVal').textContent = tDown + ' GB';
    document.getElementById('totalTrafficVal').textContent = tTotal + ' GB';
    document.getElementById('currentRateVal').textContent = `↑${up.toFixed(1)} ↓${down.toFixed(1)} KB/s`;

    const total = ((Number(net.totalUp || 0) + Number(net.totalDown || 0)) / (1024 ** 3)).toFixed(2);
    const ptt = document.getElementById('probeTrafficTotal');
    if (ptt) ptt.textContent = `探针累计流量：${total} GB`;
  }

  setInterval(() => { refreshDetail().catch(() => {}); }, 3000);
  refreshDetail().catch(() => {});

  const tabSdk = document.getElementById('tabSdk');
  const tabProbe = document.getElementById('tabProbe');
  const sdkPanel = document.getElementById('sdkPanel');
  const probePanel = document.getElementById('probePanel');
  if (tabSdk && tabProbe && sdkPanel && probePanel) {
    tabSdk.addEventListener('click', () => {
      tabSdk.className = 'px-3 py-1.5 text-sm bg-slate-900 text-white';
      tabProbe.className = 'px-3 py-1.5 text-sm bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200';
      sdkPanel.classList.remove('hidden');
      probePanel.classList.add('hidden');
    });
    tabProbe.addEventListener('click', () => {
      tabProbe.className = 'px-3 py-1.5 text-sm bg-slate-900 text-white';
      tabSdk.className = 'px-3 py-1.5 text-sm bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200';
      probePanel.classList.remove('hidden');
      sdkPanel.classList.add('hidden');
    });
  }

  const editModal = document.getElementById('editModal');
  const editProbeForm = document.getElementById('editProbeForm');

  document.getElementById('openEditModal').addEventListener('click', () => {
    const f = editProbeForm;
    f.querySelector('[name="name"]').value = '{{ server.name }}';
    f.querySelector('[name="tag"]').value = '{{ server.tag }}';
    f.querySelector('[name="notes"]').value = '{{ server.notes }}';
    f.querySelector('[name="ecs_instance_id"]').value = '{{ server.ecs_instance_id or "" }}';
    editModal.classList.remove('hidden');
    editModal.classList.add('flex');
  });

  document.getElementById('closeEditModal').addEventListener('click', () => {
    editModal.classList.add('hidden');
    editModal.classList.remove('flex');
  });

  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      editModal.classList.add('hidden');
      editModal.classList.remove('flex');
    }
  });

  editProbeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const payload = Object.fromEntries(formData.entries());
    const res = await fetch('/api/probe/servers/{{ server.id }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (res.ok) window.location.reload();
    else alert('保存失败');
  });

  document.getElementById('resetTokenBtn').addEventListener('click', async () => {
    if (!confirm('重置后旧 Token 将失效，已部署的 Agent 需要重新配置。确认重置？')) return;
    const res = await fetch('/api/probe/servers/{{ server.id }}/reset-token', { method: 'POST' });
    const data = await res.json();
    if (res.ok && data.success) {
      alert('Token 已重置为: ' + data.token + '\n请更新 Agent 配置。');
      window.location.reload();
    }
  });
</script>
{% endblock %}
