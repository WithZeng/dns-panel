{% extends 'base.html' %}

{% block content %}
<div class="mx-auto w-full max-w-2xl">
    <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 p-6 sm:p-8">
        <h1 class="text-2xl font-bold text-slate-800 dark:text-white mb-1">å®ä¾‹è‡ªåŠ¨å‘ç°</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">è¾“å…¥ AK/SK æ‰«ææŒ‡å®šåŒºåŸŸä¸‹çš„æ‰€æœ‰ ECS å®ä¾‹ã€‚</p>

        <form method="POST" class="space-y-4 mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">AccessKey
                        ID</label>
                    <input name="access_key_id" type="text" required
                        class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">AccessKey
                        Secret</label>
                    <input name="access_key_secret" type="password" required
                        class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm">
                </div>
            </div>

            <!-- Region Selector (same as add_instance) -->
            <div class="relative">
                <label for="region_select"
                    class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">åŒºåŸŸ ID</label>
                <select id="region_select"
                    class="w-full appearance-none bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 pr-10 text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                    <optgroup label="ååŒ—">
                        <option value="cn-beijing">cn-beijingï¼ˆåŒ—äº¬ï¼‰</option>
                        <option value="cn-zhangjiakou">cn-zhangjiakouï¼ˆå¼ å®¶å£ï¼‰</option>
                        <option value="cn-huhehaote">cn-huhehaoteï¼ˆå‘¼å’Œæµ©ç‰¹ï¼‰</option>
                        <option value="cn-wulanchabu">cn-wulanchabuï¼ˆä¹Œå…°å¯Ÿå¸ƒï¼‰</option>
                    </optgroup>
                    <optgroup label="åä¸œ">
                        <option value="cn-hangzhou">cn-hangzhouï¼ˆæ­å·ï¼‰</option>
                        <option value="cn-shanghai">cn-shanghaiï¼ˆä¸Šæµ·ï¼‰</option>
                        <option value="cn-nanjing">cn-nanjingï¼ˆå—äº¬ï¼‰</option>
                        <option value="cn-fuzhou">cn-fuzhouï¼ˆç¦å·ï¼‰</option>
                    </optgroup>
                    <optgroup label="åå—">
                        <option value="cn-shenzhen">cn-shenzhenï¼ˆæ·±åœ³ï¼‰</option>
                        <option value="cn-heyuan">cn-heyuanï¼ˆæ²³æºï¼‰</option>
                        <option value="cn-guangzhou">cn-guangzhouï¼ˆå¹¿å·ï¼‰</option>
                    </optgroup>
                    <optgroup label="è¥¿å—">
                        <option value="cn-chengdu">cn-chengduï¼ˆæˆéƒ½ï¼‰</option>
                    </optgroup>
                    <optgroup label="æ¸¯æ¾³å°">
                        <option value="cn-hongkong">cn-hongkongï¼ˆé¦™æ¸¯ï¼‰</option>
                    </optgroup>
                    <optgroup label="äºšå¤ª">
                        <option value="ap-southeast-1">ap-southeast-1ï¼ˆæ–°åŠ å¡ï¼‰</option>
                        <option value="ap-southeast-2">ap-southeast-2ï¼ˆæ‚‰å°¼ï¼‰</option>
                        <option value="ap-southeast-3">ap-southeast-3ï¼ˆå‰éš†å¡ï¼‰</option>
                        <option value="ap-southeast-5">ap-southeast-5ï¼ˆé›…åŠ è¾¾ï¼‰</option>
                        <option value="ap-southeast-6">ap-southeast-6ï¼ˆé©¬å°¼æ‹‰ï¼‰</option>
                        <option value="ap-southeast-7">ap-southeast-7ï¼ˆæ›¼è°·ï¼‰</option>
                        <option value="ap-northeast-1">ap-northeast-1ï¼ˆä¸œäº¬ï¼‰</option>
                        <option value="ap-northeast-2">ap-northeast-2ï¼ˆé¦–å°”ï¼‰</option>
                        <option value="ap-south-1">ap-south-1ï¼ˆå­Ÿä¹°ï¼‰</option>
                    </optgroup>
                    <optgroup label="æ¬§æ´²ä¸ç¾æ´²">
                        <option value="us-east-1">us-east-1ï¼ˆå¼—å‰å°¼äºšï¼‰</option>
                        <option value="us-west-1">us-west-1ï¼ˆç¡…è°·ï¼‰</option>
                        <option value="eu-west-1">eu-west-1ï¼ˆä¼¦æ•¦ï¼‰</option>
                        <option value="eu-central-1">eu-central-1ï¼ˆæ³•å…°å…‹ç¦ï¼‰</option>
                    </optgroup>
                    <optgroup label="ä¸­ä¸œ">
                        <option value="me-east-1">me-east-1ï¼ˆè¿ªæ‹œï¼‰</option>
                        <option value="me-central-1">me-central-1ï¼ˆåˆ©é›…å¾—ï¼‰</option>
                    </optgroup>
                    <option value="__custom__">âœï¸ è‡ªå®šä¹‰è¾“å…¥...</option>
                </select>
                <span class="pointer-events-none absolute right-3 top-[43px] text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M5.23 7.21a.75.75 0 011.06.02L10 11.16l3.71-3.93a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                            clip-rule="evenodd" />
                    </svg>
                </span>
                <input id="region_custom" type="text"
                    class="hidden mt-2 w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-4 py-3 text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                    placeholder="è¾“å…¥è‡ªå®šä¹‰ Region ID">
                <input id="region_id" name="region_id" type="hidden" required value="cn-hangzhou">
            </div>

            <button type="submit"
                class="w-full bg-slate-900 dark:bg-blue-600 text-white font-medium py-3 rounded-xl hover:bg-slate-800 dark:hover:bg-blue-700 transition-colors shadow-lg shadow-slate-900/10">
                ğŸ” æ‰«æå®ä¾‹
            </button>
        </form>

        {% if discovered %}
        <div class="border-t border-slate-100 dark:border-slate-700 pt-5">
            <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-3">å‘ç° {{ discovered|length }} ä¸ªå®ä¾‹
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr
                            class="border-b border-slate-100 dark:border-slate-700 text-left text-slate-500 dark:text-slate-400">
                            <th class="py-2 pr-4">Instance ID</th>
                            <th class="py-2 pr-4">åç§°</th>
                            <th class="py-2 pr-4">çŠ¶æ€</th>
                            <th class="py-2">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in discovered %}
                        <tr class="border-b border-slate-50 dark:border-slate-700/50">
                            <td class="py-2.5 pr-4 font-mono text-xs text-slate-600 dark:text-slate-300">{{
                                d.instance_id }}</td>
                            <td class="py-2.5 pr-4 text-slate-700 dark:text-slate-200">{{ d.name or '-' }}</td>
                            <td class="py-2.5 pr-4">
                                {% if d.status == 'Running' %}
                                <span
                                    class="inline-flex items-center text-xs font-medium text-emerald-600 dark:text-emerald-400">â—
                                    Running</span>
                                {% elif d.status == 'Stopped' %}
                                <span
                                    class="inline-flex items-center text-xs font-medium text-red-500 dark:text-red-400">â—
                                    Stopped</span>
                                {% else %}
                                <span class="text-xs text-slate-400">{{ d.status }}</span>
                                {% endif %}
                            </td>
                            <td class="py-2.5">
                                {% if d.already_added %}
                                <span class="text-xs text-slate-400 dark:text-slate-500">å·²æ·»åŠ </span>
                                {% else %}
                                <a href="{{ url_for('main.add_instance') }}?instance_id={{ d.instance_id }}&region_id={{ d.region_id }}&name={{ d.name }}"
                                    class="text-xs font-medium text-blue-600 dark:text-blue-400 hover:underline">+
                                    æ·»åŠ </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('main.dashboard') }}"
            class="block text-center text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 text-sm mt-4">â†
            è¿”å›</a>
    </div>
</div>

<script>
    (function () {
        const regionSelect = document.getElementById('region_select');
        const regionCustom = document.getElementById('region_custom');
        const regionHidden = document.getElementById('region_id');

        const currentRegion = regionHidden.value;
        const matchOption = regionSelect.querySelector('option[value="' + currentRegion + '"]');
        if (matchOption) {
            matchOption.selected = true;
        } else if (currentRegion && currentRegion !== 'cn-hangzhou') {
            regionSelect.value = '__custom__';
            regionCustom.classList.remove('hidden');
            regionCustom.value = currentRegion;
        }

        regionSelect.addEventListener('change', function () {
            if (this.value === '__custom__') {
                regionCustom.classList.remove('hidden');
                regionCustom.focus();
                regionHidden.value = regionCustom.value;
            } else {
                regionCustom.classList.add('hidden');
                regionCustom.value = '';
                regionHidden.value = this.value;
            }
        });

        regionCustom.addEventListener('input', function () {
            regionHidden.value = this.value;
        });
    })();
</script>
{% endblock %}